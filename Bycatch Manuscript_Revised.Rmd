---
title: "Bycatch Manuscript - Revision"
author: "Shawn Dsouza"
date: "25 March 2020"
output:
  html_document:
    code_folding: hide
    css: style.css
    df_print: kable
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
options(max.print="75")
knitr::opts_chunk$set(echo = T, error = T, warning = F, message = F, tidy = T, cache = T,
                      dpi = 300, fig.align = "center")

#Required libraries

require(plyr)
require(tidyverse)
require(lubridate)
library(RColorBrewer)

#Importing data

snakes = read.csv("./Data/Sea-snakes_fish-dep_mastersheet_260320.csv")


# Fixing tow duration for 2018 - 2019

snakes <- snakes%>%
  group_by(Year, Gear.Type)%>%
  mutate(n.hauls = ifelse(is.na(No..of.Hauls), #filling in missing data
                         mean(No..of.Hauls, na.rm = T), No..of.Hauls),
         haul.time = ifelse(is.na(Average.Haul.Duration..Hours.), 
                         mean(Average.Haul.Duration..Hours., na.rm = T),
                         Average.Haul.Duration..Hours.))%>%
  ungroup()%>%
  mutate(Tow.duration.hours = 
           ifelse(is.na(Tow.duration.hours), # only for TD not recorded
                    ifelse(Gear.Type == "GillNet", #for gillnets
                            (haul.time+1.75), #soak time correction
                           ifelse(Gear.Type == "Trawler", #for trawlers
                                  n.hauls*haul.time, # total tow duration
                                  Tow.duration.hours) #return unchanged
                           ), #return unchanged
                    Tow.duration.hours)# return same for TD recorded
         )

#selecting relavent vars
  
snakes <- snakes%>%
  filter(Year < 2019)%>% #removing 2019 data
  mutate(#Year = as.factor(Year),
         Month = factor(months(dmy(Date), abbreviate = T), levels = month.abb))%>%
  select(Date, Boat.Name...Owner, Gear.Type, Field.Code, Species, # Trip/species vars
         Month, Year, Location.Encounterd,  Fishing.Location, #seasonality and geographic vars 
         #Fishing.Trip.Start, Fishing.Trip.End, # time of dat
         Condition.at.encounter..D.A., # mortality
         #No..of.Hauls,Average.Haul.Duration..Hours., # effort
         Tow.duration.hours, #effort
         Snout.to.Vent..cm., Weight..g., Sex, Class) # morphometrics
  
table(is.na(snakes$Tow.duration.hours))
      
theme_set(theme_bw()+
            theme(legend.position = "top",
                  text = element_text(size = 15)
                  )
          )#setting ggplot theme

# function calculating mcfadden's pseudo r2 for glms

mcfadden <- function(x){
  r2 <- 1 - (x$deviance/x$null.deviance)
}



```

# Composition of sea snakes in bycatch

## Sampling effort

```{r}
#Number of boats sampled accross years

snakes%>%
  group_by(Year, Month)%>%
  distinct(Date, Boat.Name...Owner, .keep_all = T)%>%
  #filter(!Boat.Name...Owner == "")%>%
  count(name = "n.trips")%>%
  spread(Month, n.trips)
  
# Fishing effort accross years

snakes%>%
  group_by(Year, Month)%>%
  distinct(Date, Boat.Name...Owner, .keep_all = T)%>%
  #filter(!Boat.Name...Owner == "")%>% # some non descript effort data for 2016/2017
  summarise(sampling.effort = round(sum(Tow.duration.hours, na.rm = T), 2))%>%
  spread(Month, sampling.effort)

snakes%>%
  filter(Gear.Type == "Trawler" | Gear.Type == "GillNet")%>%
  group_by(Gear.Type)%>%
  distinct(Date, Boat.Name...Owner, .keep_all = T)%>%
  #filter(!Boat.Name...Owner == "")%>% # some non descript effort data for 2016/2017
  summarise(n.trips = n(),
            sampling.effort = round(sum(Tow.duration.hours, na.rm = T), 2))
```

Sampling was not conducted trip wise for 2016 and most of 2017. Hence, effort data is unavailable.

## Assemblage composition

```{r}
snakes%>%
  group_by(Species, Year)%>%
  count(name = "Abundance")%>%
  spread(Year, Abundance)
```


## Abundacne accross years
```{r}
snakes%>%
  group_by(Year, Species)%>%
  filter(Species == "Hydrophis curtus" | Species == "Hydrophis schistosus")%>%
  count()%>%
  ggplot(aes(Year, n, shape = Species, group = Species))+
  geom_point(size = 3)+
  geom_line(aes(linetype = Species), size = 1)+
  theme(legend.text = element_text(face = "italic"))
```

Sampling effort is uneven, which may explain the difference in abundance

```{r}

# testing effect of years on assemblage composition

abn <- snakes%>%
  group_by(Year, Species)%>%
  filter(Species == "Hydrophis curtus" | Species == "Hydrophis schistosus")%>%
  count()%>%
  spread(Species, n)%>%
  mutate(Total = (`Hydrophis curtus`+`Hydrophis schistosus`))

prop.year <- prop.test(abn$`Hydrophis curtus`, abn$Total)

broom::tidy(prop.year)%>%
  select(estimate1:p.value)
```

Assemblage composition is significantly different accross years.

## Varition in CPUE across years by gear

```{r}
snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  #filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Year, Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort, mean for 2016 - 17
  complete(nesting(Year, Gear.Type, Date, Boat.Name...Owner, fe), 
           Species, fill = list(Abn = 0))%>% # completing species x trip combinations
  group_by(Year, Gear.Type, Species)%>%
  summarise(CPUE = mean(Abn/fe, na.rm = T), # Mean CPUE per trip
            sd = sd(Abn/fe, na.rm = T))%>% 
  ggplot(aes(Year, CPUE, shape = Species, group = Species))+
  geom_point(size = 3)+
  geom_line(aes(linetype = Species), size = 1)+
  #geom_errorbar(aes(ymax = CPUE + sd, ymin = CPUE - sd), size = 1, width = 0.1)+
  scale_x_continuous(breaks = seq(2016, 2018, 1))+
  labs(y = "Mean CPUE")+
  facet_wrap(~Gear.Type)+
  theme(legend.text = element_text(face = "italic"))

ggsave("./Figures/figure 1.tiff", device = "tiff", last_plot(), dpi = "print", 
       height = 4.5, width = 8)
```

```{r}
CPUE.grsp <- snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  #filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Year, Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort, mean for 2016 - 17
  complete(nesting(Year, Gear.Type, Date, Boat.Name...Owner, fe), 
           Species, fill = list(Abn = 0))%>% # completing species x trip combinations
  mutate(cpue = Abn/fe)

CPUE.grsp%>%
  group_by(Gear.Type, Species)%>%
  summarise(Mean.CPUE = mean(cpue, na.rm = T))%>%
  spread(Species, Mean.CPUE)
```

```{r}
# testing difference in CPUE between trawlers and gillnets

CPUE.grsp%>%
  group_by(Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(cpue ~ Gear.Type, data = ., family = poisson(link = "log"))),
         sumry = map(mod, broom::tidy),
         pseudo.r2 = map(mod, ~mcfadden(.)))%>%
  select(sumry, pseudo.r2)%>%
  unnest()
```

```{r}
# testing difference in CPUE between Species

CPUE.grsp%>%
  group_by(Gear.Type)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(cpue ~ Species, data = ., family = poisson())),
         sumry = map(mod, broom::tidy),
         pseudo.r2 = map(mod, ~mcfadden(.)))%>%
  select(sumry, pseudo.r2)%>%
  unnest()
```

## Seasonal variation in CPUE

```{r}
snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  #filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  mutate(Month = factor(Month, levels = month.abb))%>%
  group_by(Year, Month, Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort, mean for 2016 - 17
  complete(nesting(Year, Gear.Type, Date, Boat.Name...Owner, fe), Month, 
           Species, fill = list(Abn = 0))%>% # completing species x trip combinations
  group_by(Month, Gear.Type, Species)%>%
  summarise(CPUE = mean(Abn/fe, na.rm = T), # Mean CPUE per trip
            sd = sd(Abn/fe, na.rm = T))%>%
  ggplot(aes(Month, CPUE, shape = Species,  group = Species))+
  geom_point(size = 3)+
  geom_line(aes(linetype = Species), size = 1)+
  scale_y_log10()+
  #geom_errorbar(aes(ymax = CPUE + sd, ymin = CPUE - sd), size = 1, width = 0.1)+
  #adding monsoon ban period
  geom_vline(xintercept = "Jun", size = 1, linetype = "dotted")+
  geom_vline(xintercept = "Aug", size = 1, linetype = "dotted")+
  geom_text(aes(x = "Jul", y = 0.3, label = "Monsoon Ban"))+
  labs(y = "Mean CPUE (log)")+
  facet_wrap(~Gear.Type, ncol = 1)+
  theme(legend.text = element_text(face = "italic"))

ggsave("./Figures/figure 2.tiff", device = "tiff", last_plot(), dpi = "print", 
       height = 4.5, width = 8)
```

- Show gap in sampling
- Mean CPUE shoulb be independent of effort

```{r}
# testing seasonality in CPUE by gear

CPUE.month <- snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  #filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Year, Month, Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort, mean for 2016 - 17
  complete(nesting(Year, Month, Gear.Type, Date, Boat.Name...Owner, fe),  
           Species, fill = list(Abn = 0))%>% # completing species x trip combinations
  #group_by(Month, Gear.Type, Species)%>%
  mutate(CPUE = Abn/fe) # Mean CPUE per trip
            
CPUE.month%>%
  ungroup()%>%
  group_by(Gear.Type, Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(CPUE ~ Month, data = .)),
         sumry = map(mod, broom::tidy))%>%
  select(sumry)%>%
  unnest()%>%
  select(term, estimate)%>%
  spread(term, estimate, drop = T)

CPUE.month%>%
  ungroup()%>%
  group_by(Gear.Type, Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(CPUE ~ Month, data = .)),
         sumry = map(mod, broom::tidy),
         tst = map(mod, car::Anova))%>%
  select(tst)%>%
  unnest()
```


## Length distribution in bycatch

```{r}
snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  ggplot(aes(Snout.to.Vent..cm., fill = Gear.Type))+
  geom_density(aes(linetype = Gear.Type),alpha = 0.3, size = 1)+
  labs(x = "Snout to vent length (cm)", y = "Kernel Density")+
  facet_wrap(~Species)+
  theme(strip.text = element_text(face = "italic"))
```

No selectivity of SVL in either gear.

- Does mesh size affect catch composition?

```{r}
# summaru SVL

snakes%>%
  filter(Species == "Hydrophis curtus" | Species == "Hydrophis schistosus")%>%
  group_by(Species)%>%
  skimr::skim(Snout.to.Vent..cm.)%>%
  skimr::yank("numeric")
```


```{r}
snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>%
  filter(!is.na(Snout.to.Vent..cm.))%>%
  droplevels()%>%
  select(Gear.Type, Species, Snout.to.Vent..cm.)%>%
  group_by(Species)%>%
  nest()%>%
  mutate(t.test = map(data, ~t.test(Snout.to.Vent..cm. ~ Gear.Type, data = .)),
         sumry = map(t.test, broom::tidy),
         d = map(data, ~lsr::cohensD(Snout.to.Vent..cm. ~ Gear.Type, data = .)))%>%
  unnest(sumry, d)%>%
  select(estimate:p.value, d)
```

## Sex distibution in bycatch

```{r}
snakes%>%
  filter(Sex == "Male" | Sex == "Female")%>% # sex recorded
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  ggplot(aes(Species, fill = Sex))+
  geom_bar(position = "dodge", col = "black", width = 0.25)+
  scale_fill_brewer(palette = "Greys")+
  facet_wrap(~Gear.Type)+
  theme(axis.text.x = element_text(face = "italic"))
```

```{r}
proptest.r <- function(x, y){
  r <- x$statistic/sum(y$N)
}

snakes%>%
  filter(Sex == "Male" | Sex == "Female")%>% # sex recorded
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>%
  group_by(Gear.Type, Species, Sex)%>%
  count()%>%
  spread(Sex, n)%>%
  mutate(N = Male+Female)%>%
  group_by(Species)%>%
  nest()%>%
  mutate(prop = map(data, ~prop.test(.$Female, .$N)),
         sumry = map(prop, broom::tidy),
         r = map2(prop, data, ~proptest.r(x = .x, y = .y)))%>%
  unnest(sumry, r)%>%
  select(estimate1, estimate2, p.value, conf.low, conf.high, r)
```

Significantly more male _H. curtus_ caught in trawler than gillnets


# Effect of effort on composition of sea snakes

```{r}
CPUE = snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort, mean for 2016 - 17
  complete(nesting(Gear.Type, Date, Boat.Name...Owner, fe), 
           Species, fill = list(Abn = 0))%>%
  mutate(CPUE = Abn/fe,
         log.Abn = log(Abn),
         log.CPUE = log(CPUE),# log CPUE because CPUE is 0 inflated
          log.fe = log(fe))# fe is 0 inflated

CPUE%>%
  group_by(Gear.Type)%>%
  distinct(Date, Boat.Name...Owner)%>%
  count()
```

```{r}
CPUE%>%
  ggplot(aes(log.fe, log.CPUE, shape = Species))+
  geom_jitter(size = 3)+
  geom_smooth(aes(linetype = Species), method = "lm", col = "black")+
  scale_color_brewer(palette = "Greys")+
  labs(y = "CPUE (log)", x = "Fishing Effort (log haul hours)")+
  facet_wrap(~ Gear.Type, scales = "free_x")+
  theme(legend.text = element_text(face = "italic"))
```

```{r}
# testing 
CPUE%>%
  #filter(!is.nan(log.CPUE), !is.infinite(log.CPUE))%>%
  group_by(Gear.Type, Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(CPUE ~ fe, data = ., family = poisson())),
         sumry = map(mod, broom::tidy),
         pseudo.r2 = map(mod, ~mcfadden(.)))%>%
  select(sumry, pseudo.r2)%>%
  unnest()
```

# Mortality rates of sea snakes in bycatch by gear

```{r}
mortality <- snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  group_by(Gear.Type, Species)%>%
  summarise(n.alive = sum(Condition.at.encounter..D.A. == "Alive"),
            n.dead = sum(Condition.at.encounter..D.A. == "Dead"),
            mort.rate = (n.dead/(n.dead+n.alive))*100)

knitr::kable(mortality)
```

```{r}
mortality%>%
  ggplot(aes(Species, mort.rate, fill = Gear.Type))+
  geom_col(position = "dodge", col = "black", width = 0.25)+
  scale_fill_brewer(palette = "Greys")+
  labs(x = "Species", y = "Mortality Rate (%)")+
  theme(axis.text.x = element_text(face = "italic"))

ggsave("./Figures/figure 3.tiff", device = "tiff", last_plot(), dpi = "print", 
       height = 4.5, width = 4.5)
```

Overall (population) mortality rate is higher for both species in Trawlers and is higher overall for _H. curtus_ compared to _H. schistosus_

- Should mortality be calculated at the trip level?

```{r}
mort.grsp <- snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  #filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  select(Gear.Type, Date, Boat.Name...Owner, Species, Condition.at.encounter..D.A.)%>%
  rename(Condition = Condition.at.encounter..D.A.)
  #summarise(n = n())%>% # abundance of sea snakes per trip
  #complete(nesting(Gear.Type, Date, Boat.Name...Owner), 
   #        Species, Condition.at.encounter..D.A., # completing species x tcondition combinations
    #       fill = list(n = 0))
  #group_by(Gear.Type, Date, Boat.Name...Owner, Species)%>%
  #mutate(Abn = sum(n))%>%
  #filter(Condition.at.encounter..D.A. == "Dead")%>%
  #mutate(mort.rate = n/Abn)%>%
  #filter(!is.nan(mort.rate))%>%
  #select(Date, Boat.Name...Owner, Gear.Type, Species, mort.rate)

```

```{r}
# testing difference in mortality between trawlers and gillnets

mort.grsp%>%
  group_by(Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(Condition ~ Gear.Type, data = ., family = binomial())),
         sumry = map(mod, broom::tidy),
         stat = map(mod, ~mcfadden(.)))%>%
  select(sumry, stat)%>%
  unnest()
```

```{r}
# testing difference in CPUE between Species

mort.grsp%>%
  group_by(Gear.Type)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(Condition ~ Species, data = ., family = binomial())),
         sumry = map(mod, broom::tidy),
         stat = map(mod, ~mcfadden(.)))%>%
  select(sumry, stat)%>%
  unnest()
```

## Effect of effort on mortality rate

```{r}
mortality.trip <- snakes%>%
  filter(Gear.Type == "GillNet" | Gear.Type == "Trawler")%>%
  filter(!Boat.Name...Owner == "")%>% # removing points with no effort 
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Gear.Type, Date, Boat.Name...Owner, Species)%>%
  summarise(n.alive = sum(Condition.at.encounter..D.A. == "Alive"),
            n.dead = sum(Condition.at.encounter..D.A. == "Dead"),
            Abn = n(), # abundance of sea snakes per trip
            mort.rate = n.dead/(n.alive+n.dead),
            fe = mean(Tow.duration.hours, na.rm = T))

mortality.trip%>%
  group_by(Gear.Type, Species)%>%
  count()%>%
  spread(Species, n)
```

```{r}
mortality.trip%>%
  ggplot(aes(fe, mort.rate, shape = Species))+
  geom_point(size = 3)+
  geom_smooth(aes(linetype = Species), method = "lm", col = "black")+
  scale_x_log10()+
  scale_y_log10()+
  labs(x = "Fishing Effort (log haul hours)", y = "Mortality Rate (log)")+
  facet_wrap(~ Gear.Type, scales = "free_x")+
  theme(legend.text = element_text(face = "italic"))
```

Fishing effort does not seem to have any effect on mortality rate. Samples size may be too small to infer.

```{r}
mortality.trip%>%
  #filter(!is.nan(log.CPUE), !is.infinite(log.CPUE))%>%
  group_by(Gear.Type, Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(mort.rate ~ fe, data = ., family = poisson())),
         sumry = map(mod, broom::tidy),
         r2 = map(mod, ~mcfadden(.)))%>%
  select(sumry, r2)%>%
  unnest()
```

Mortality rate of _H. curtus_ may increase with haultime in trawlers

# Change in sea snake assemblages

Only trawlers will be considered for this part of the analysis.

```{r}
past_studies <- read.csv("./Data/Past Studies_Data.csv")

past_studies <- past_studies%>%
  rename(Study = ï..Study)
#past_studies<-past_studies%>%
 # mutate(Year = as.factor(Year))
```
## Sampling effort accross years

```{r}
effort.studies <- snakes%>%
  filter(Gear.Type == "Trawler",
         #Boat.Name...Owner != ""
         )%>%
  group_by(Year)%>%
  distinct(Date, Boat.Name...Owner, .keep_all = T)%>%
  summarise(N.trips = n(),
            Total.fe = sum(Tow.duration.hours, na.rm = T))

effort.studies <-  past_studies%>%
  select(Year, N.trips, Total.fe)%>%
  distinct(Year, .keep_all = T)%>%
  bind_rows(effort.studies)

knitr::kable(effort.studies)
```

Data is pooled across study period for Lobo and Padate

- Why is effort higher in original analysis?

## Variation in CPUE of sea snakes in Trawlers

```{r}
CPUE.studies <- snakes%>%
  filter(Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  droplevels()%>%
  group_by(Year, Date, Boat.Name...Owner, Species)%>%
  summarise(Abn = n(), # abundance of sea snakes per trip
            fe = mean(Tow.duration.hours, na.rm = T))%>% # fishing effort
  complete(nesting(Year, Date, Boat.Name...Owner, fe), 
           Species, fill = list(Abn = 0))%>% # completing species x trip combinations
  group_by(Year, Species)%>%
  summarise(Mean.CPUE = mean(Abn/fe, na.rm = T), # Mean CPUE per trip
            sd = sd(Abn/fe, na.rm = T),
            Total.Abn = sum(Abn, na.rm = T),
            Total.fe = sum(fe, na.rm = T))

CPUE.studies <- past_studies%>%
  select(Year, Species, Mean.CPUE, sd, Total.Abn, Total.fe)%>%
  bind_rows(CPUE.studies)

# may need to use log
```

- What is the mean CPUE in each study?
- Are they accross multiple years?
- What is the total effort?
- Abundance by species?

```{r}
CPUE.studies%>%
  ggplot(aes(Year, Mean.CPUE, shape = Species, group = Species))+
  geom_point(size = 3)+
  geom_line(aes(linetype = Species), size = 1)+
  #geom_errorbar(aes(ymax = CPUE + sd, ymin = CPUE - sd), size = 1, width = 0.1)+
  labs(y = "Mean CPUE")+
  theme(legend.text = element_text(face = "italic"))
```

```{r}
CPUE.studies%>%
  group_by(Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(Mean.CPUE ~ Year, data = .)),
         sumry = map(mod, broom::tidy))%>%
  select(sumry)%>%
  unnest()%>%
  arrange(desc(-p.value))
```


## Change in abundance across studies

```{r}
CPUE.studies%>%
  ggplot(aes(Year, Total.Abn, shape = Species, group = Species))+
  geom_point(size = 3)+
  geom_line(aes(linetype = Species), size = 1)+
  #geom_errorbar(aes(ymax = CPUE + sd, ymin = CPUE - sd), size = 1, width = 0.1)+
  scale_y_log10()+
  labs(y = "Abundance")+
  theme(legend.text = element_text(face = "italic"))
```

```{r}
CPUE.studies%>%
  group_by(Species)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(Total.Abn ~ Year, data = .)),
         sumry = map(mod, broom::tidy))%>%
  select(sumry)%>%
  unnest()%>%
  arrange(desc(-p.value))
```

## Assemblage composition accross studies

```{r}
assemblage <- CPUE.studies%>%
  group_by(Year)%>%
  mutate(Total = sum(Total.Abn))%>%
  group_by(Year, Species)%>%
  summarise(rel.prop = Total.Abn/Total)%>%
  ggplot(aes(Year, rel.prop))+
  geom_point(aes(shape = Species), size = 3)+
  geom_line(aes(linetype = Species, group = Species), size = 1)+
  #geom_errorbar(aes(ymax = CPUE + sd, ymin = CPUE - sd), size = 1, width = 0.1)+
  labs(y = "Relative Aundance in byactch")+
  theme(axis.text.x = element_blank())+
  theme(legend.text = element_text(face = "italic"),
        axis.title.x = element_blank())

# adding study periods to plot

study_periods <- read.csv("./Data/study_periods.csv")

study_periods$study <- study_periods$ï..study

# rectangle plot
period1 <-  ggplot(study_periods)+
  geom_rect(aes(xmin = start.year, xmax = end.year, ymax = 1, ymin = -1,
                fill = study),  col = "black", 
                 size = 0.1, height = 0.1)+
  geom_text(aes(x = median.year, y = 0, label = study), size = 3)+
  scale_fill_brewer(palette = "Greys", guide = F)+
  #scale_y_continuous(limits = c(0.5, 1.3))+
  labs(x = "Year")+
  theme_void()+
  theme(text = element_text(size = 15),
        axis.title.x = element_text(size = 15))

# arrow plot
period <-  ggplot(study_periods)+
  geom_errorbarh(aes(xmin = start.year, xmax = end.year, y = 1.75), 
                 size = 1)+
  geom_text(aes(x = median.year, y = 0.75, label = study), size = 3.5)+
  scale_y_continuous(limits = c(0, 2.25))+
  labs(x = "Year")+
  theme_void()+
  theme(text = element_text(size =15),
        axis.title.x = element_text(size = 15),
        axis.text.x = element_text())

# final plot
ggpubr::ggarrange(assemblage, period, 
                  ncol = 1, 
                  heights = c(1, 0.2),
                  align = "v")

ggsave("./Figures/figure 4.tiff", device = "tiff", last_plot(), dpi = "print", 
       height = 4.5, width = 8)

```

```{r}
CPUE.studies%>%
  group_by(Year)%>%
  mutate(N = sum(Total.Abn))%>%
  filter(Species == "Hydrophis curtus")%>%
  #summarise(rel.prop = Total.Abn/Total)%>%
  ungroup()%>%
  nest()%>%
  mutate(proptest = map(data, ~prop.test(.$Total.Abn, .$N)),
         #mod = map(data, ~lm(rel.prop ~ Year, data = .)),
         sumry = map(proptest, broom::tidy),
         r = map2(proptest, data, ~proptest.r(.x, .y)))%>%
  select(sumry,r)%>%
  unnest()%>%
  select(estimate1:p.value, r)
```

## Difference in mortality of sea snakes in Trawlers

```{r}
mortality.studies <- snakes%>%
  filter(Gear.Type == "Trawler")%>%
  filter(Species == "Hydrophis curtus" | 
           Species == "Hydrophis schistosus")%>% # keeping dominant species
  group_by(Year, Species)%>%
  summarise(n.alive = sum(Condition.at.encounter..D.A. == "Alive"),
            n.dead = sum(Condition.at.encounter..D.A. == "Dead"),
            mort.rate = (n.dead/(n.dead+n.alive)),
            Study = "Current")

mortality.studies <- past_studies%>%
  select(Study, Year, Species, n.alive, n.dead, mort.rate)%>%
  bind_rows(mortality.studies)%>%
  mutate(N = n.alive + n.dead)%>%
  mutate(Study = factor(Study, levels = c("Lobo (2004)", "Padate et al. (2009)", "Current")))%>%
  group_by(Study, Species)%>%
  summarise(n.dead = sum(n.dead),
            N = sum(N),
            mort.rate = n.dead/N)
  

knitr::kable(mortality.studies)
```

- n.alive, n.dead, total for each study each species

```{r}
mortality.studies%>%
  ggplot(aes(Study, mort.rate, shape = Species))+
  geom_point(aes(group = Species),size = 3)+
  geom_path(aes( linetype = Species), size = 1)+
  #geom_col(position = position_dodge(preserve = "single"), col = "black", width = 0.25)+
  scale_fill_brewer(palette = "Greys")+
  labs(x = "Year", y = "Mortality Rate (%)")+
  theme(legend.text = element_text(face = "italic"))
```

- Data missing for H. schistosus in Trawlers for 2019

```{r}
mortality.studies%>%
  group_by(Species)%>%
  drop_na()%>%
  nest()%>%
  mutate(proptest = map(data, ~prop.test(.$n.dead, .$N)),
         #mod = map(data, ~lm(rel.prop ~ Year, data = .)),
         sumry = map(proptest, broom::tidy),
         r = map2(proptest, data, ~proptest.r(.x, .y)))%>%
  select(sumry,r)%>%
  unnest()%>%
  select(estimate1:p.value, r)
```


# Increase in fishing pressure in Konkan 2000 - 2020


```{r}
vessels <- read.csv("./Data/state-craft-gear.csv")

vessels$Year <- vessels$ï..Year
```

```{r}
vessels%>%
  ggplot(aes(Year, n, shape = Craft))+
  geom_point(size = 3)+
  geom_line(aes(group = Craft, linetype = Craft), size = 1)+
  scale_y_sqrt()+
  labs(y = "No. of Vessels (sq. rt.)")+
  facet_wrap(~ State, ncol = 1)

ggsave("./Figures/figure 5.tiff", device = "tiff", last_plot(), dpi = "print", 
       height = 6, width = 8)

```

```{r}

#testing change in number of vessels over years

vessels%>%
  group_by(State, Craft)%>%
  nest()%>%
  mutate(mod = map(data, ~glm(n ~ Year, data = ., family = poisson())),
         sumry = map(mod, broom::tidy),
         r2 = map(mod, ~mcfadden(.)))%>%
  select(sumry, r2)%>%
  unnest()%>%
  arrange(desc(r2))
```

```{r}

#testing difference in number of vessels between Mah and Goa

vessels%>%
  group_by(Craft)%>%
  nest()%>%
  mutate(mod = map(data, ~t.test(n ~ State, data = .)),
         sumry = map(mod, broom::tidy),
         d = map(data, ~lsr::cohensD(n ~ State, data = .)))%>%
  select(sumry, d)%>%
  unnest()%>%
  arrange(desc(d))%>%
  select(estimate:p.value, d)
```

# Study site map

```{r}
library(tmap)
library(osmdata)

study_sites <- read.csv("./data/study_site.csv")

# geocoding study sites

library(ggmap)

study_sites <- study_sites%>%
  mutate(Name = as.character(Name))%>%
  mutate_geocode(Name)

knitr::kable(study_sites)
```


```{r}
# converting to simplfe feature

library(sf)

study_sites <- st_as_sf(study_sites, coords = c("lon", "lat"))

st_crs(study_sites) <- 4326

# getting study extent

study_ext <- st_bbox(study_sites)

# getting osm map

library(osmdata)

land_raw <- opq(bbox = study_ext)%>%
  add_osm_feature(key = 'admin_level', value = '4')%>%
  osmdata_sf()%>%
  unique_osmdata()
  
land <- land_raw$osm_multipolygons

st_crs(land) <- 4326

# plotting site map

ss_main <- tm_shape(land)+
  tm_polygons()+
  tm_text("name", remove.overlap = F)+
tm_shape(study_sites, , bbox = study_ext+c(-0.5,-.5,0.5,0.5), is.master = T)+
  tm_symbols(size = 1, shape = "Study", border.lwd = 2.5, border.col = "black", col = "gray")+
  tm_text("Name", size = 0.7,fontface = "bold",
          ymod = -0.7, xmod = -0.75, remove.overlap = T)+
  tm_graticules(n.x = 5)+
  tm_scale_bar(position = c("left", "top"), text.size = 0.5) + 
  tm_compass(position = c('right', 'top'), size = 5)+
  tm_style(style = "gray")+
  tm_layout(scale = 1.5, legend.position = c("left", "bottom"))

# making inset map

india <- read_sf("./Data/India-States.shp")

ext <- st_as_sfc(study_ext+c(-1.2,-1.2,1.2,1.2))

ss_inset <- tm_shape(india)+
  tm_polygons()+
tm_shape(ext)+
  tm_borders(lwd = 3)+
  tm_style("gray")+
  tm_layout(scale = 1.5)

# making final map

vp <- grid::viewport(x = 0.8, y = 0.175, width = 0.2, height = 0.3)

tmap_save(ss_main, insets_tm = ss_inset, insets_vp = vp, 
          "./Figures/Figure_1.tiff", height = 8, width = 8)

```

